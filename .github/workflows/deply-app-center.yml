name: Deploy App Center
on:
  pull_request:
    types: [ closed ]

jobs:
  deploy-app-center:
    name: Deply on App Center
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true # && github.event.pull_request.base.ref == 'master'  # Only run for PRs targeting master  # Only run this job on PR merge
    steps:
      - name: Get Last commit tag
        run: PREV_COMMIT_ID=$(git rev-parse HEAD~1)
      - uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ PREV_COMMIT_ID }}  # Include merge timestamp
          path: app-release.apk
      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 'v20.12.2'

      - name: Update npm packages
        run: |
          npm install formidable@latest
          npm install superagent@latest

      - name: Install app center
        run: npm install -g appcenter-cli

      - name: Upload APK to App Center
        run: appcenter distribute release -f app-release.apk -a saurabh.sonar120-gmail.com/News-App --group Public --token ${{secrets.APP_CENTER_TOKEN}}
